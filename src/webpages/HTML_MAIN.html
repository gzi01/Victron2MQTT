%pre_head_template%
<div class="row gx-0 mb-2" id="vcc_alert" style="display: none;">
    <div class="alert alert-danger" role="alert" style="text-align: center;">
        <span><b>WARNING ESP VOLTAGE TO LOW</b></span>
    </div>
</div>

<figure class="text-center">
    <h2 id="devicename"></h2>
</figure>

<div class="row gx-0 mb-2">
    <div class="col">
        <div class="progress" style="height:1.8rem;">
            <div id="SOCbar" class="progress-bar" role="progressbar" style="width:0%;height:1.8rem;" aria-valuenow="0"
                aria-valuemin="0" aria-valuemax="100"></div>
        </div>
    </div>
</div>

<div class="row gx-0 mb-2">
    <div class="col">
        <div class="bg-light">Voltage: </div>
    </div>
    <div class="col">
        <div class="bg-light"><span id="volt"></span></div>
    </div>
</div>

<div class="row gx-0 mb-2">
    <div class="col">
        <div class="bg-light">Current: </div>
    </div>
    <div class="col">
        <div class="bg-light"><span id="current"></span></div>
    </div>
</div>

<div class="row gx-0 mb-2">
    <div class="col">
        <div class="bg-light">Relay: </div>
    </div>
    <div class="col">
        <div class="bg-light"><span id="relay"></span></div>
    </div>
</div>

<div class="row gx-0 mb-2" style="display: none;">
    <div class="col">
        <div class="bg-light">Consumed Kwh: </div>
    </div>
    <div class="col">
        <div class="bg-light"><span id="consD"></span><span id="consM"></span><span id="consY"></span><span
                id="consT"></span></div>
    </div>
</div>

<div class="row gx-0 mb-2" style="display: none;">
    <div class="col">
        <div class="bg-light">generated Kwh: </div>
    </div>
    <div class="col">
        <div class="bg-light"><span id="genD"></span><span id="genM"></span><span id="genY"></span><span
                id="genT"></span></div>
    </div>
</div>

<div class="row gx-0 mb-2" style="display: none;">
    <div class="col">
        <div class="bg-light">CO2 Reduction: </div>
    </div>
    <div class="col">
        <div class="bg-light"><span id="cored"></span></div>
    </div>
</div>

<div class="row gx-0 mb-2" style="display: none;">
    <div class="col">
        <div class="bg-light">Input State: </div>
    </div>
    <div class="col">
        <div class="bg-light"><span id="inputstate"></span></div>
    </div>
</div>

<div class="row gx-0 mb-2" style="display: none;">
    <div class="col">
        <div class="bg-light">Charge Mode: </div>
    </div>
    <div class="col">
        <div class="bg-light"><span id="chrgmode"></span></div>
    </div>
</div>

<div class="row gx-0 mb-2" style="display: none;">
    <div class="col">
        <div class="bg-light">Load State: </div>
    </div>
    <div class="col">
        <div class="bg-light form-check form-switch"><input class="form-check-input" type="checkbox" role="switch"
                id="loadState" /></div>
    </div>
</div>
<div class="d-grid gap-2">
    <a class="btn btn-primary btn-block" href="/settings" role="button">Settings</a>
</div>

<script>
    var gateway = `ws://${window.location.hostname}/ws`;
    var websocket;
    window.addEventListener('load', onLoad);
    function initWebSocket() {
        console.log('Trying to open a WebSocket connection...');
        websocket = new WebSocket(gateway);
        websocket.onopen = onOpen;
        websocket.onclose = onClose;
        websocket.onerror = onError;
        websocket.onmessage = onMessage;
    }
    function onOpen(event) {
        console.log('Connection opened');
        setInterval(checkWS, 5000);
    }
    function onClose(event) {
        console.log('Connection closed');
        setTimeout(initWebSocket, 3500);
    }
    function onError(event) {
        console.log('Connection lost');
    }

    function onMessage(event) {
        var data = JSON.parse(event.data);

        document.getElementById("devicename").innerHTML = data.Device_name == null ? 'No Connection' : data.Device_name;
        document.getElementById("volt").innerHTML = data.Voltage + 'V';
        document.getElementById("current").innerHTML = data.Battery_current + 'A';
        document.getElementById("relay").innerHTML = data.Relay;

        document.getElementById("SOCbar").innerHTML = data.SOC + '%%';
        $('#SOCbar').width(Number(data.SOC) + "%").attr('aria-valuenow', Number(data.SOC));

        if (data.ESP_Data.ESP_VCC < 2.6) {
            document.getElementById("vcc_alert").style.display = '';
        } else {
            document.getElementById("vcc_alert").style.display = 'none';
        }

    }

    function onLoad(event) {
        initWebSocket();
    }

    function checkWS() {
        websocket.send("A9");
    }
</script>
%pre_foot_template%
<p hidden>Hidden Helper</p>